<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direcci√≥n de Ambiente - Municipalidad de San Isidro</title>
    <meta name="description" content="Plataforma de gesti√≥n de eventos ambientales de la Municipalidad de San Isidro">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light green background */
        }
        .brand-green { color: #065f46; } /* Emerald 800 */
        .brand-bg-green { background-color: #065f46; } /* Emerald 800 */
        .brand-bg-light-green { background-color: #d1fae5; } /* Emerald 200 */
        .brand-border-green { border-color: #065f46; }
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Hide sections by default */
        .section {
            display: none;
        }
        /* Custom styles for the certificate */
        #certificate-template {
            width: 800px; /* Standard A4-like width */
            border: 10px solid #065f46;
            padding: 40px;
            background: white;
            font-family: 'Times New Roman', serif;
        }
        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            position: relative;
            min-height: 100px;
            border: 1px solid #e5e7eb;
            background-color: white;
            padding: 4px;
        }
        .calendar-day.other-month {
            background-color: #f9fafb;
        }
        .calendar-event {
            margin-top: 2px;
            background-color: #d1fae5; /* Emerald 200 */
            padding: 2px;
            border-radius: 4px;
            font-size: 0.75rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- App Container -->
    <div id="app-container" class="min-h-screen">

        <!-- Header -->
        <header class="p-4 shadow-md bg-white sticky top-0 z-40">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="https://drive.google.com/uc?export=download&id=1BXBBYqL3uDoPXd4i9jdRu1gFnA2McZpj" alt="Logo Municipalidad de San Isidro" class="h-12 md:h-16" onerror="this.style.display='none'">
                    <h1 class="text-lg md:text-2xl font-bold brand-green">Direcci√≥n de Ambiente</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="user-info" class="hidden text-right">
                        <p class="text-sm font-semibold" id="welcome-message"></p>
                        <button id="logout-button" class="text-sm text-red-600 hover:underline">Salir</button>
                    </div>
                    <button id="admin-login-button" class="text-sm text-gray-600 hover:underline">Admin</button>
                </div>
            </div>
        </header>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
            <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-green-700"></div>
        </div>

        <!-- Login Section -->
        <main id="login-section" class="section container mx-auto p-4 md:p-8 text-center">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 brand-green">Acceso a Eventos</h2>
                <p class="mb-6 text-gray-600">Por favor, ingrese su DNI para continuar. Si es su primer ingreso, se le pedir√° que complete sus datos.</p>
                <form id="login-form">
                    <input type="number" id="dni-input" placeholder="Ingrese su DNI sin puntos" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    <button type="submit" class="w-full mt-4 brand-bg-green text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800 transition-colors">Ingresar</button>
                </form>
            </div>
        </main>

        <!-- Registration Section -->
        <main id="register-section" class="section container mx-auto p-4 md:p-8">
            <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 brand-green">Formulario de Registro</h2>
                <p class="mb-6 text-gray-600">Es su primera vez aqu√≠. Por favor, complete el siguiente formulario para registrarse.</p>
                <form id="register-form" class="space-y-4">
                    <input type="text" id="register-dni" class="w-full px-4 py-2 border rounded-lg bg-gray-100" readonly>
                    <input type="text" id="register-name" placeholder="Nombre y Apellido" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="text" id="register-address" placeholder="Direcci√≥n" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="tel" id="register-phone" placeholder="Tel√©fono" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="email" id="register-email" placeholder="Correo Electr√≥nico" class="w-full px-4 py-2 border rounded-lg" required>
                    <div class="p-4 border rounded-lg">
                        <label class="block text-gray-700 font-medium">¬øTiene huerta o compostera?</label>
                        <div class="mt-2 flex space-x-4">
                            <label><input type="radio" name="huerta-compostera" value="si" class="mr-1"> S√≠</label>
                            <label><input type="radio" name="huerta-compostera" value="no" class="mr-1" checked> No</label>
                        </div>
                    </div>
                    <div id="huerta-address-container" class="hidden">
                        <input type="text" id="register-huerta-address" placeholder="Direcci√≥n de la huerta/compostera" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <button type="submit" class="w-full mt-4 brand-bg-green text-white font-bold py-3 px-4 rounded-lg hover:bg-green-800 transition-colors">Registrarme y Continuar</button>
                </form>
            </div>
        </main>

        <!-- Main App Section (after login) -->
        <main id="main-app-section" class="section container mx-auto p-4 md:p-8">
            <!-- Navigation Tabs -->
            <div class="mb-8 border-b border-gray-300">
                <nav class="flex space-x-2 md:space-x-4" aria-label="Tabs">
                    <button id="tab-news" class="tab-button px-3 py-3 whitespace-nowrap font-medium text-base md:text-lg text-gray-500 hover:text-gray-700">Noticias</button>
                    <button id="tab-calendar" class="tab-button px-3 py-3 whitespace-nowrap font-medium text-base md:text-lg text-gray-500 hover:text-gray-700">Calendario</button>
                    <button id="tab-turnos" class="tab-button px-3 py-3 whitespace-nowrap font-medium text-base md:text-lg text-gray-500 hover:text-gray-700">Turnos ECOescuelas</button>
                    <button id="tab-available" class="tab-button px-3 py-3 whitespace-nowrap font-medium text-base md:text-lg border-b-4 brand-border-green brand-green">Eventos</button>
                    <button id="tab-my-inscriptions" class="tab-button px-3 py-3 whitespace-nowrap font-medium text-base md:text-lg text-gray-500 hover:text-gray-700">Mis Inscripciones</button>
                </nav>
            </div>
            <div id="ecoescuelas-link" class="hidden mb-4 p-4 bg-yellow-100 rounded-lg text-center">
                <a href="https://drive.google.com/file/d/1eQne65n4E2QqqGdHzE9xAJuUgYpQ-tWm/view?usp=sharing" target="_blank" class="text-green-800 font-bold underline">Documento ECOESCUELAS</a>
            </div>

            <!-- Available Courses View -->
            <div id="view-available-courses">
                    <h3 class="text-3xl font-bold mb-6 brand-green">Pr√≥ximos Eventos</h3>
                <div id="courses-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </div>

            <!-- Calendar View -->
            <div id="view-calendar" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                    <h3 id="calendar-month-year" class="text-2xl font-bold brand-green"></h3>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
                </div>
                <div class="calendar-grid font-bold text-center text-sm text-gray-600 mb-2">
                    <div>Dom</div><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div>
                </div>
                <div id="calendar-body" class="calendar-grid"></div>
            </div>

            <!-- My Inscriptions View -->
            <div id="view-my-inscriptions" class="hidden">
                 <h3 class="text-3xl font-bold mb-6 brand-green">Mis Inscripciones</h3>
                 <!-- Gamification Badges Section -->
                 <div class="mb-8 p-4 bg-white rounded-lg shadow">
                     <h4 class="font-bold text-xl brand-green mb-3">Mis Insignias de Vecino/a Sustentable</h4>
                     <div id="my-badges-list" class="flex flex-wrap gap-4">
                         <p class="text-gray-500">Completa eventos para ganar insignias.</p>
                     </div>
                 </div>
                 <div id="my-inscriptions-list" class="space-y-6"></div>
            </div>

            <!-- Turnos View -->
            <div id="view-turnos" class="hidden">
                <h3 class="text-3xl font-bold mb-6 brand-green">Reservar turno ECOescuelas</h3>
                <form id="turno-form" class="space-y-4 mb-8">
                    <input type="text" id="turno-institucion" placeholder="Nombre de la instituci√≥n" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="text" id="turno-direccion" placeholder="Direcci√≥n (calle, n√∫mero y barrio)" class="w-full px-4 py-2 border rounded-lg" required>
                    <label class="flex items-center space-x-2"><input type="checkbox" id="turno-es-escuela"><span>¬øEs escuela?</span></label>
                    <p id="escuela-note" class="text-sm text-gray-600 hidden">Pueden haber hasta 6 talleres anuales por escuela.</p>
                    <div id="turno-datos-escuela" class="space-y-2 hidden">
                        <select id="turno-tipo" class="w-full px-4 py-2 border rounded-lg">
                            <option value="publica">Instituci√≥n p√∫blica</option>
                            <option value="privada">Instituci√≥n privada</option>
                        </select>
                        <input type="text" id="turno-grado" placeholder="Grado" class="w-full px-4 py-2 border rounded-lg">
                        <select id="turno-nivel" class="w-full px-4 py-2 border rounded-lg">
                            <option value="inicial">Inicial</option>
                            <option value="primaria">Primaria</option>
                            <option value="secundaria">Secundaria</option>
                        </select>
                        <input type="number" id="turno-alumnos" placeholder="N√∫mero de alumnos (m√°x. 30)" max="30" class="w-full px-4 py-2 border rounded-lg">
                        <select id="turno-taller" class="w-full px-4 py-2 border rounded-lg">
                            <option value="GIRSU: Reciclables">GIRSU: Reciclado</option>
                            <option value="GIRSU: Compostaje">GIRSU: Compostaje</option>
                            <option value="Cuidado del agua">Cuidado del agua</option>
                            <option value="Cambio Clim√°tico: Transporte">Cambio Clim√°tico: Transporte</option>
                            <option value="Cambio Clim√°tico: Energ√≠a">Cambio Clim√°tico: Energ√≠a</option>
                        </select>
                        <input type="text" id="turno-referente" placeholder="Nombre del referente a cargo" class="w-full px-4 py-2 border rounded-lg">
                        <textarea id="turno-observaciones" placeholder="Observaciones (opcional)" class="w-full px-4 py-2 border rounded-lg"></textarea>
                    </div>
                    <input type="text" id="turno-telefono" placeholder="Tel√©fono de contacto" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="email" id="turno-email" placeholder="Mail de contacto" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="number" id="turno-asistentes" placeholder="Cantidad de asistentes" class="w-full px-4 py-2 border rounded-lg" required>
                    <select id="turno-slot" class="w-full px-4 py-2 border rounded-lg" required></select>
                    <button type="submit" class="w-full brand-bg-green text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800">Reservar</button>
                </form>
                <h4 class="text-xl font-bold brand-green">Mis Turnos Reservados</h4>
                <div id="mis-turnos-list" class="space-y-4 mt-4"></div>
            </div>
            
            <!-- News View -->
            <div id="view-news" class="hidden">
                <h3 class="text-3xl font-bold mb-6 brand-green">Noticias Ambientales</h3>
                <div id="news-list" class="space-y-6"></div>
            </div>
        </main>
        
        <!-- Admin Section -->
        <main id="admin-section" class="section container mx-auto p-4 md:p-8">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold brand-green">Panel de Administraci√≥n</h2>
                <button id="admin-logout-button" class="text-sm text-red-600 hover:underline">Salir de Admin</button>
            </div>
            <!-- Admin Tabs -->
            <div class="mb-8 border-b border-gray-300">
                <nav class="flex space-x-4" aria-label="Admin Tabs">
                    <button data-view="admin-dashboard" class="admin-tab-button px-4 py-2 font-medium text-gray-500">Dashboard</button>
                    <button data-view="admin-courses" class="admin-tab-button px-4 py-2 font-medium border-b-4 brand-border-green brand-green">Gestionar Eventos</button>
                    <button data-view="admin-turnos" class="admin-tab-button px-4 py-2 font-medium text-gray-500">Turnera</button>
                    <button data-view="admin-news" class="admin-tab-button px-4 py-2 font-medium text-gray-500">Gestionar Noticias</button>
                    <button data-view="admin-efemerides" class="admin-tab-button px-4 py-2 font-medium text-gray-500">Gestionar Efem√©rides</button>
                    <button data-view="admin-enrollments" class="admin-tab-button px-4 py-2 font-medium text-gray-500">Inscriptos</button>
                </nav>
            </div>
            <!-- Admin Dashboard View -->
            <div id="admin-dashboard-view" class="hidden">
                <div id="dashboard-stats" class="mb-6"></div>
                <canvas id="enroll-chart" class="w-full max-w-3xl mx-auto"></canvas>
            </div>
            <!-- Admin Courses View -->
            <div id="admin-courses-view">
                <button id="add-course-button" class="mb-6 brand-bg-green text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800 transition-colors">+ Crear Nuevo Evento</button>
                <div id="admin-courses-list" class="space-y-4"></div>
            </div>
            <!-- Admin Turnos View -->
            <div id="admin-turnos-view" class="hidden">
                <button id="add-slot-button" class="mb-6 brand-bg-green text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800 transition-colors">+ Nuevo Turno</button>
                <button id="generate-month-button" class="mb-6 brand-bg-green text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800 transition-colors">+ Cargar Mes</button>
                <h4 class="text-xl font-bold brand-green mb-2">Turnos Habilitados</h4>
                <div id="admin-turnos-list" class="space-y-4 mb-6"></div>
                <div class="flex items-end space-x-2 mb-2">
                    <h4 class="text-xl font-bold brand-green">Turnos Tomados</h4>
                    <input type="date" id="export-start" class="border px-2 py-1 rounded" />
                    <input type="date" id="export-end" class="border px-2 py-1 rounded" />
                    <button id="export-turnos" class="bg-blue-600 text-white px-2 py-1 rounded text-sm">Descargar CSV</button>
                </div>
                <div id="admin-turnos-reserved" class="space-y-4 mb-6"></div>
                <h4 class="text-xl font-bold brand-green mb-2">Turnos Sin Tomar</h4>
                <div id="admin-turnos-free" class="space-y-4"></div>
            </div>
            <!-- Admin News View -->
            <div id="admin-news-view" class="hidden">
                <button id="add-news-button" class="mb-6 brand-bg-green text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800 transition-colors">+ Crear Nueva Noticia</button>
                <div id="admin-news-list" class="space-y-4"></div>
            </div>
            <!-- Admin Efemerides View -->
            <div id="admin-efemerides-view" class="hidden">
                <button id="add-efemeride-button" class="mb-6 brand-bg-green text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800 transition-colors">+ Crear Nueva Efem√©ride</button>
                <div id="admin-efemerides-list" class="space-y-4"></div>
            </div>
            <!-- Admin Enrollments View -->
            <div id="admin-enrollments-view" class="hidden">
                <h4 class="text-xl font-bold brand-green mb-4">Listado General de Inscriptos</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-4 py-2 text-left">Nombre</th>
                                <th class="px-4 py-2 text-left">Instituci√≥n</th>
                                <th class="px-4 py-2 text-left">Huerta/Compostera</th>
                                <th class="px-4 py-2 text-left">Evento</th>
                            </tr>
                        </thead>
                        <tbody id="enrollments-table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- MODALS (Admin, Survey, etc.) -->
        <div id="course-form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-full overflow-y-auto">
                <h3 id="course-form-title" class="text-2xl font-bold mb-6 brand-green"></h3>
                <form id="course-form" class="space-y-4">
                    <input type="hidden" id="course-id">
                    <input type="text" id="course-title" placeholder="T√≠tulo" class="w-full px-4 py-2 border rounded-lg" required>
                    <textarea id="course-description" placeholder="Descripci√≥n" class="w-full px-4 py-2 border rounded-lg" required></textarea>
                    <input type="text" id="course-speaker" placeholder="Disertante" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="date" id="course-date" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="text" id="course-location" placeholder="Lugar / Enlace" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="text" id="course-format" placeholder="Formato (Ej: Presencial, Virtual)" class="w-full px-4 py-2 border rounded-lg" required>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="course-capacity" placeholder="Cupo (0 para ilimitado)" class="w-full px-4 py-2 border rounded-lg">
                        <label class="flex items-center space-x-2"><input type="checkbox" id="course-waitlist"><span>Habilitar lista de espera</span></label>
                    </div>
                    <textarea id="course-materials" placeholder="Materiales (un enlace por l√≠nea)" class="w-full px-4 py-2 border rounded-lg h-24"></textarea>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-course-form" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" class="brand-bg-green text-white font-bold py-2 px-6 rounded-lg">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="news-form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full max-h-full overflow-y-auto">
                <h3 id="news-form-title" class="text-2xl font-bold mb-6 brand-green"></h3>
                <form id="news-form" class="space-y-4">
                    <input type="hidden" id="news-id">
                    <input type="text" id="news-title" placeholder="T√≠tulo de la Noticia" class="w-full px-4 py-2 border rounded-lg" required>
                    <textarea id="news-content" placeholder="Contenido de la noticia..." class="w-full px-4 py-2 border rounded-lg h-48" required></textarea>
                    <input type="text" id="news-image-url" placeholder="URL de imagen (opcional)" class="w-full px-4 py-2 border rounded-lg">
                    <textarea id="news-files" placeholder="Enlaces de archivos (uno por l√≠nea)" class="w-full px-4 py-2 border rounded-lg h-24"></textarea>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-news-form" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" class="brand-bg-green text-white font-bold py-2 px-6 rounded-lg">Guardar Noticia</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="efemeride-form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
                <h3 id="efemeride-form-title" class="text-2xl font-bold mb-6 brand-green"></h3>
                <form id="efemeride-form" class="space-y-4">
                    <input type="hidden" id="efemeride-id">
                    <input type="text" id="efemeride-title" placeholder="T√≠tulo de la Efem√©ride" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="date" id="efemeride-date" class="w-full px-4 py-2 border rounded-lg" required>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-efemeride-form" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" class="brand-bg-green text-white font-bold py-2 px-6 rounded-lg">Guardar Efem√©ride</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="slot-form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full">
                <h3 id="slot-form-title" class="text-2xl font-bold mb-6 brand-green"></h3>
                <form id="slot-form" class="space-y-4">
                    <input type="hidden" id="slot-id">
                    <input type="date" id="slot-date" class="w-full px-4 py-2 border rounded-lg" required>
                    <input type="time" id="slot-time" list="slot-times" class="w-full px-4 py-2 border rounded-lg" required>
                    <datalist id="slot-times">
                        <option value="09:00">
                        <option value="11:00">
                        <option value="13:30">
                        <option value="15:00">
                    </datalist>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-slot-form" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" class="brand-bg-green text-white font-bold py-2 px-6 rounded-lg">Guardar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="enrolled-users-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full max-h-full overflow-y-auto">
                <div class="flex justify-between items-center">
                    <h3 id="enrolled-users-title" class="text-2xl font-bold mb-6 brand-green"></h3>
                    <button id="export-csv-button" class="mb-6 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 text-sm">Exportar a CSV</button>
                </div>
                <div id="enrolled-users-content"></div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="close-enrolled-users-modal" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cerrar</button>
                </div>
            </div>
        </div>
        
        <div id="survey-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
                <h3 class="text-2xl font-bold mb-6 brand-green">Encuesta de Satisfacci√≥n</h3>
                <form id="survey-form" class="space-y-4">
                    <input type="hidden" id="survey-course-id">
                    <div>
                        <label class="font-medium">Calidad del contenido (1-5):</label>
                        <div id="rating-content" class="flex space-x-2 text-2xl cursor-pointer"><span>‚òÜ</span><span>‚òÜ</span><span>‚òÜ</span><span>‚òÜ</span><span>‚òÜ</span></div>
                    </div>
                    <div>
                        <label class="font-medium">Desempe√±o del disertante (1-5):</label>
                        <div id="rating-speaker" class="flex space-x-2 text-2xl cursor-pointer"><span>‚òÜ</span><span>‚òÜ</span><span>‚òÜ</span><span>‚òÜ</span><span>‚òÜ</span></div>
                    </div>
                    <textarea id="survey-comments" placeholder="Comentarios adicionales..." class="w-full px-4 py-2 border rounded-lg h-24"></textarea>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-survey-form" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" class="brand-bg-green text-white font-bold py-2 px-6 rounded-lg">Enviar Encuesta</button>
                    </div>
                </form>
            </div>
</div>

        <div id="course-materials-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
                <h3 id="course-materials-title" class="text-2xl font-bold mb-6 brand-green"></h3>
                <div id="course-materials-links" class="space-y-2"></div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="close-course-materials-modal" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- Admin Password Modal -->
        <div id="admin-password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full">
                <h3 class="text-2xl font-bold mb-6 brand-green">Acceso de Administrador</h3>
                <form id="admin-password-form">
                    <label for="admin-password-input" class="block mb-2 text-sm font-medium text-gray-900">Contrase√±a</label>
                    <input type="password" id="admin-password-input" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2.5" required>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-admin-password-form" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" class="brand-bg-green text-white font-bold py-2 px-6 rounded-lg">Ingresar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                <h3 class="text-xl font-bold mb-4 brand-green">Confirmaci√≥n Requerida</h3>
                <p id="confirmation-message" class="mb-6"></p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-confirmation-button" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button id="confirm-action-button" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Confirmar</button>
                </div>
            </div>
        </div>

        <div id="certificate-container" class="fixed top-0 left-[-9999px]">
            <div id="certificate-template">
                <div class="text-center mb-8">
                    <img src="https://www.sanisidro.gob.ar/sites/default/files/logo_msi_horizontal_0.png" alt="Logo" class="h-20 mx-auto mb-4">
                    <h1 class="text-3xl font-bold" style="color: #065f46;">Direcci√≥n de Ambiente</h1>
                    <h2 class="text-2xl" style="color: #065f46;">Municipalidad de San Isidro</h2>
                </div>
                <div class="text-center my-12">
                    <p class="text-xl mb-4">Se otorga el presente</p>
                    <h3 class="text-5xl font-bold" style="font-family: 'Brush Script MT', cursive;">Certificado de Asistencia</h3>
                    <p class="text-xl mt-4">a:</p>
                </div>
                <div class="text-center my-8">
                    <p id="cert-user-name" class="text-3xl font-semibold border-b-2 border-gray-400 pb-2 inline-block"></p>
                </div>
                <div class="text-center text-lg my-8">
                    <p>Por haber participado y finalizado satisfactoriamente el evento de:</p>
                    <p id="cert-course-name" class="text-2xl font-bold my-4" style="color: #065f46;"></p>
                </div>
                <div class="text-center mt-16 text-base">
                    <p>Finalizado el <span id="cert-completion-date"></span>.</p>
                    <p class="mt-2">San Isidro, Provincia de Buenos Aires.</p>
                </div>
            </div>
        </div>
        
        <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm text-center">
                <p id="modal-message-text" class="text-lg mb-6"></p>
                <button id="modal-close-button" class="brand-bg-green text-white font-bold py-2 px-6 rounded-lg hover:bg-green-800">Cerrar</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, getDocs, query, where, onSnapshot, writeBatch, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & INITIALIZATION ---
        const firebaseConfig = {
  apiKey: "AIzaSyDrvFqzpX-E2RZrOzKBDVoZJiGasQ-FkiI",
  authDomain: "capacitaciones-app-7583b.firebaseapp.com",
  projectId: "capacitaciones-app-7583b",
  storageBucket: "capacitaciones-app-7583b.appspot.com",
  messagingSenderId: "540192676165",
  appId: "1:540192676165:web:ae93c5b661b5ce6838062c"
};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'san-isidro-capacitaciones';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentUserId = null;
        let isAuthReady = false;
        let isAdminLoggedIn = false;
        let currentCalendarDate = new Date();
        let allCourses = []; // Cache for calendar
        let allEfemerides = [];
        let userEnrollments = {}; // Track user enrollments
        let actionToConfirm = null; // For confirmation modal
        let enrollChart = null;

        // --- DOM ELEMENTS ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const sections = { login: document.getElementById('login-section'), register: document.getElementById('register-section'), main: document.getElementById('main-app-section'), admin: document.getElementById('admin-section') };
        const views = { available: document.getElementById('view-available-courses'), calendar: document.getElementById('view-calendar'), myInscriptions: document.getElementById('view-my-inscriptions'), turnos: document.getElementById('view-turnos'), news: document.getElementById('view-news') };
        const tabs = { available: document.getElementById('tab-available'), calendar: document.getElementById('tab-calendar'), myInscriptions: document.getElementById('tab-my-inscriptions'), turnos: document.getElementById('tab-turnos'), news: document.getElementById('tab-news') };
        const userInfoDiv = document.getElementById('user-info');
        const welcomeMessage = document.getElementById('welcome-message');
        const courseFormModal = document.getElementById('course-form-modal');
        const newsFormModal = document.getElementById('news-form-modal');
        const courseForm = document.getElementById('course-form');
        const newsForm = document.getElementById('news-form');
        const enrolledUsersModal = document.getElementById('enrolled-users-modal');
        const surveyModal = document.getElementById('survey-modal');
        const courseMaterialsModal = document.getElementById('course-materials-modal');
        const courseMaterialsTitle = document.getElementById('course-materials-title');
       const courseMaterialsLinks = document.getElementById('course-materials-links');
       const adminPasswordModal = document.getElementById('admin-password-modal');
       const confirmationModal = document.getElementById('confirmation-modal');
       const myBadgesList = document.getElementById('my-badges-list');
        const turnoForm = document.getElementById('turno-form');
        const turnoSlotSelect = document.getElementById('turno-slot');
       const misTurnosList = document.getElementById('mis-turnos-list');
       const datosEscuelaDiv = document.getElementById('turno-datos-escuela');
       const slotFormModal = document.getElementById('slot-form-modal');
       const slotForm = document.getElementById('slot-form');
       const adminTurnosList = document.getElementById('admin-turnos-list');
       const adminTurnosReserved = document.getElementById('admin-turnos-reserved');
       const adminTurnosFree = document.getElementById('admin-turnos-free');
       const addSlotButton = document.getElementById('add-slot-button');
       const generateMonthButton = document.getElementById('generate-month-button');
       const dashboardStats = document.getElementById('dashboard-stats');
       const enrollmentsTableBody = document.getElementById('enrollments-table-body');
        
        // --- MOCK DATA (Only for first time setup) ---
        async function setupMockData() {
            const coursesRef = collection(db, 'artifacts', appId, 'public', 'data', 'courses');
            const snapshot = await getDocs(coursesRef);
            if (snapshot.empty) {
                console.log("No courses found. Setting up mock data...");
                const mockCourses = [
                    { title: 'Iniciaci√≥n al Compostaje Dom√©stico', speaker: 'Lic. Ana P√©rez', date: '2025-08-15', location: 'Vivero Municipal', format: 'Presencial', description: 'Aprende los secretos para transformar tus residuos org√°nicos.', materials: [], capacity: 20, waitlist: true, badge: 'compostaje' },
                    { title: 'Mi Primera Huerta en Balc√≥n', speaker: 'Ing. Agr. Carlos Rodriguez', date: '2025-08-22', location: 'Online via Zoom', format: 'Virtual', description: 'Descubre c√≥mo cultivar tus propias hortalizas.', materials: [], capacity: 0, waitlist: false, badge: 'huerta' },
                ];
                for (const course of mockCourses) { await addDoc(coursesRef, course); }
            }
        }

        // --- UI & VIEW MANAGEMENT ---
        function showSection(sectionName) {
            Object.values(sections).forEach(s => s.style.display = 'none');
            if (sections[sectionName]) sections[sectionName].style.display = 'block';
        }
        
        function showView(viewName) {
             Object.values(views).forEach(v => v.style.display = 'none');
             Object.values(tabs).forEach(t => t.className = 'tab-button px-3 py-3 whitespace-nowrap font-medium text-base md:text-lg text-gray-500 hover:text-gray-700');
             if(views[viewName]) {
                 views[viewName].style.display = 'block';
                 tabs[viewName].className = 'tab-button px-3 py-3 whitespace-nowrap font-medium text-base md:text-lg border-b-4 brand-border-green brand-green';
                 document.getElementById('ecoescuelas-link').style.display = viewName === 'turnos' ? 'block' : 'none';
             }
        }
        
        function showModal(message, isEmailSimulation = false) {
            if (isEmailSimulation) {
                message = `üìß SIMULACI√ìN: ${message}. En una aplicaci√≥n real, se enviar√≠a un email.`;
            }
            document.getElementById('modal-message-text').textContent = message;
            document.getElementById('message-modal').style.display = 'flex';
        }


        async function sendEmail(to, subject, text){
            try {
                await fetch("/api/send-email", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ to, subject, text })
                });
            } catch(e){ console.error("email", e); }
        }

        function showConfirmationModal(message, onConfirm) {
            document.getElementById('confirmation-message').textContent = message;
            actionToConfirm = onConfirm;
            confirmationModal.style.display = 'flex';
        }

        // --- AUTHENTICATION & INITIAL LOAD ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                isAuthReady = true;
                await setupMockData();
                const storedDNI = localStorage.getItem('userDNI');
                if(storedDNI) await attemptLogin(storedDNI);
                else showSection('login');
                listenToAllData(); // Start listening for courses and news
            } else {
                isAuthReady = false;
                currentUserId = null;
                showSection('login');
            }
            loadingSpinner.style.display = 'none';
        });

        async function initializeAuth() {
            try {
                loadingSpinner.style.display = 'flex';
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showModal("Error de autenticaci√≥n. Por favor, recargue la p√°gina.");
            }
        }
        
        // --- DATA LISTENERS ---
        function listenToAllData() {
            const coursesRef = collection(db, 'artifacts', appId, 'public', 'data', 'courses');
            onSnapshot(coursesRef, (snapshot) => {
                const coursesListDiv = document.getElementById('courses-list');
                coursesListDiv.innerHTML = '';
                allCourses = [];
                snapshot.forEach(doc => {
                    const course = { id: doc.id, ...doc.data() };
                    allCourses.push(course);
                    coursesListDiv.innerHTML += createCourseCard(course);
                });
                renderCalendar();
                document.querySelectorAll('.enroll-button').forEach(button => button.addEventListener('click', handleEnrollment));
                updateCourseCards();
            });

            const efeRef = collection(db, 'artifacts', appId, 'public', 'data', 'efemerides');
            onSnapshot(efeRef, (snapshot) => {
                allEfemerides = [];
                snapshot.forEach(doc => { allEfemerides.push(doc.data()); });
                renderCalendar();
            });

            const newsRef = collection(db, 'artifacts', appId, 'public', 'data', 'news');
            onSnapshot(query(newsRef, orderBy("date", "desc")), (snapshot) => {
                const newsListDiv = document.getElementById('news-list');
                newsListDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const newsItem = { id: doc.id, ...doc.data() };
                    let attachmentsHTML = '';
                    if (newsItem.imageUrl) {
                        attachmentsHTML += `<img src="${newsItem.imageUrl}" class="w-full mt-4 rounded-lg" />`;
                    }
                    if (newsItem.files && newsItem.files.length > 0) {
                        const links = newsItem.files.map(link => `<a href="${link}" target="_blank" class="text-blue-600 hover:underline block">${link}</a>`).join('');
                        attachmentsHTML += `<div class="mt-4 p-4 brand-bg-light-green rounded-lg"><h5 class="font-bold mb-2">Archivos Adjuntos</h5>${links}</div>`;
                    }
                    const card = `
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h4 class="text-2xl font-bold brand-green mb-2">${newsItem.title}</h4>
                             <p class="text-sm text-gray-500 mb-2">Publicado el ${new Date(newsItem.date).toLocaleDateString('es-AR', {timeZone: 'UTC'})}</p>
                            <p class="text-gray-700 whitespace-pre-wrap">${newsItem.content}</p>
                            ${attachmentsHTML}
                        </div>
                    `;
                    newsListDiv.innerHTML += card;
                });
            });

            const turnosRef = collection(db, 'artifacts', appId, 'public', 'data', 'turnos');
            onSnapshot(turnosRef, () => {
                loadAvailableTurnos();
                if (currentUserId) loadUserTurnos();
            });
        }
        
        // --- USER FUNCTIONS ---
        async function attemptLogin(dni) {
            if (!isAuthReady) { showModal("El sistema de autenticaci√≥n no est√° listo."); return; }
            loadingSpinner.style.display = 'flex';
            const dniRegistryRef = doc(db, 'artifacts', appId, 'public', 'data', 'dni_registry', dni);
            const dniRegistrySnap = await getDoc(dniRegistryRef);
            if (dniRegistrySnap.exists()) {
                const registeredUid = dniRegistrySnap.data().uid;
                const userProfileRef = doc(db, 'artifacts', appId, 'users', registeredUid);
                const userProfileSnap = await getDoc(userProfileRef);
                if (userProfileSnap.exists()) {
                    currentUser = userProfileSnap.data();
                    currentUserId = registeredUid; 
                    localStorage.setItem('userDNI', dni);
                    await showMainApp();
                } else {
                    document.getElementById('register-dni').value = dni;
                    showSection('register');
                }
            } else {
                document.getElementById('register-dni').value = dni;
                showSection('register');
            }
            loadingSpinner.style.display = 'none';
        }

        async function showMainApp() {
            welcomeMessage.textContent = `Bienvenido/a, ${currentUser.name.split(' ')[0]}`;
            userInfoDiv.style.display = 'block';
            showSection('main');
            showView('available');
            await loadMyInscriptions();
            await loadAvailableTurnos();
            await loadUserTurnos();
        }

        function createCourseCard(course) {
            return `
                <div class="card course-card bg-white rounded-xl shadow-md overflow-hidden p-6 border-l-4 brand-border-green flex flex-col" data-course-id="${course.id}">
                    <h4 class="text-xl font-bold brand-green mb-2">${course.title}</h4>
                    <p class="text-gray-600 mb-4 flex-grow">${course.description}</p>
                    <div class="space-y-2 text-sm text-gray-800">
                        <p><strong>Disertante:</strong> ${course.speaker}</p>
                        <p><strong>Fecha:</strong> ${new Date(course.date).toLocaleDateString('es-AR', {timeZone: 'UTC'})}</p>
                        <p><strong>Lugar:</strong> ${course.location}</p>
                        <p><strong>Formato:</strong> ${course.format}</p>
                        ${course.capacity > 0 ? `<p><strong>Cupo:</strong> <span id="capacity-${course.id}">${course.capacity}</span></p>` : ''}
                    </div>
                    <button data-course-id="${course.id}" data-course-title="${course.title}" class="enroll-button w-full mt-4 brand-bg-green text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800 transition-colors">Inscribirme</button>
                </div>
            `;
        }

        function updateCourseCards() {
            document.querySelectorAll('.course-card').forEach(card => {
                const courseId = card.dataset.courseId;
                const button = card.querySelector('.enroll-button');
                if (!button) return;
                if (userEnrollments[courseId]) {
                    card.classList.add('bg-gray-200');
                    button.textContent = 'Ya est√°s inscripto';
                    button.className = 'enroll-button w-full mt-4 bg-gray-400 text-white font-bold py-2 px-4 rounded-lg cursor-default';
                    button.disabled = true;
                } else {
                    card.classList.remove('bg-gray-200');
                    button.textContent = 'Inscribirme';
                    button.className = 'enroll-button w-full mt-4 brand-bg-green text-white font-bold py-2 px-4 rounded-lg hover:bg-green-800 transition-colors';
                    button.disabled = false;
                }
            });
        }
        
        async function handleEnrollment(event) {
            if (!currentUser) { showModal("Debe iniciar sesi√≥n para inscribirse."); return; }
            const { courseId, courseTitle } = event.target.dataset;
            const courseRef = doc(db, 'artifacts', appId, 'public', 'data', 'courses', courseId);
            const courseSnap = await getDoc(courseRef);
            if (!courseSnap.exists()) { showModal("Este evento ya no existe."); return; }
            const course = courseSnap.data();
            const enrolledUsersRef = collection(courseRef, 'enrolledUsers');
            const waitlistedUsersRef = collection(courseRef, 'waitlistedUsers');
            const [enrolledSnap, waitlistedSnap] = await Promise.all([getDocs(enrolledUsersRef), getDocs(waitlistedUsersRef)]);
            const isAlreadyEnrolled = enrolledSnap.docs.some(d => d.id === currentUserId || d.data().dni === currentUser.dni);
            const isAlreadyWaitlisted = waitlistedSnap.docs.some(d => d.id === currentUserId || d.data().dni === currentUser.dni);
            if (isAlreadyEnrolled || isAlreadyWaitlisted) { showModal(`Ya se encuentra inscripto/a o en lista de espera para "${courseTitle}".`); return; }
            loadingSpinner.style.display = 'flex';
            try {
                if (course.capacity > 0 && enrolledSnap.size >= course.capacity) {
                    if (course.waitlist) {
                        await setDoc(doc(waitlistedUsersRef, currentUserId), { name: currentUser.name, dni: currentUser.dni, email: currentUser.email, timestamp: new Date() });
                        const msgWait = `El cupo est√° lleno. Has sido a√±adido a la lista de espera para "${courseTitle}".`;
                        sendEmail(currentUser.email, 'Lista de espera', msgWait);
                        showModal(msgWait);
                    } else { showModal(`Lo sentimos, el cupo para "${courseTitle}" est√° completo.`); }
                } else {
                    const batch = writeBatch(db);
                    batch.set(doc(enrolledUsersRef, currentUserId), { name: currentUser.name, dni: currentUser.dni, email: currentUser.email, status: 'inscripto' });
                    batch.set(doc(db, 'artifacts', appId, 'users', currentUserId, 'enrollments', courseId), { status: 'inscripto', completionDate: null, surveyCompleted: false });
                    await batch.commit();
                    const msgEnroll = `¬°Inscripci√≥n exitosa a "${courseTitle}"!`;
                    sendEmail(currentUser.email, 'Inscripci√≥n confirmada', msgEnroll);
                    showModal(msgEnroll);
                }
                loadMyInscriptions();
            } catch (error) {
                console.error("Error al inscribirse:", error);
                showModal("Hubo un error al procesar su inscripci√≥n.");
            } finally { loadingSpinner.style.display = 'none'; }
        }

        async function loadMyInscriptions() {
            const inscriptionsListDiv = document.getElementById('my-inscriptions-list');
            if (!currentUserId) return;
            const enrollmentsRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'enrollments');
            onSnapshot(enrollmentsRef, async (snapshot) => {
                if (snapshot.empty) { inscriptionsListDiv.innerHTML = '<p>A√∫n no se ha inscripto a ning√∫n evento.</p>'; userEnrollments = {}; updateCourseCards(); renderBadges([]); return; }
                inscriptionsListDiv.innerHTML = '';
                userEnrollments = {};
                let completedCoursesCount = 0;
                for (const enrollmentDoc of snapshot.docs) {
                    const enrollment = { id: enrollmentDoc.id, ...enrollmentDoc.data() };
                    userEnrollments[enrollment.id] = true;
                    const courseDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'courses', enrollment.id);
                    const courseSnap = await getDoc(courseDocRef);
                    if (courseSnap.exists()) {
                        const course = courseSnap.data();
                        let materialsHTML = '';
                        if(course.materials && course.materials.length > 0) {
                            const links = course.materials.map(link => `<a href="${link}" target="_blank" class="text-blue-600 hover:underline block">${link}</a>`).join('');
                            materialsHTML = `<div class="mt-4 p-4 brand-bg-light-green rounded-lg"><h5 class="font-bold mb-2">Material de Cursada</h5>${links}</div>`;
                        }
                        let actionsHTML = '';
                        if(course.materials && course.materials.length > 0) {
                            actionsHTML += `<button data-course-id="${enrollment.id}" class="view-materials-button bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm mr-2">Ver Archivos</button>`;
                        }
                        if (enrollment.status === 'finalizado') {
                            completedCoursesCount++;
                            actionsHTML += `<button data-course-name="${course.title}" data-completion-date="${enrollment.completionDate}" class="download-cert-button bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">Descargar Certificado</button>`;
                            if (!enrollment.surveyCompleted) {
                                actionsHTML += `<button data-course-id="${enrollment.id}" class="open-survey-button bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors text-sm ml-2">Realizar Encuesta</button>`;
                            }
                        }
                        inscriptionsListDiv.innerHTML += `<div class="bg-white rounded-xl shadow-md overflow-hidden p-6"><div class="md:flex justify-between items-start"><div><h4 class="text-xl font-bold brand-green">${course.title}</h4><p class="text-gray-600"><strong>Fecha:</strong> ${new Date(course.date).toLocaleDateString('es-AR', {timeZone: 'UTC'})}</p><p class="capitalize font-semibold mt-2"><strong>Estado:</strong> <span class="${enrollment.status === 'finalizado' ? 'text-green-600' : 'text-yellow-600'}">${enrollment.status}</span></p></div><div class="mt-4 md:mt-0 md:text-right">${actionsHTML}</div></div>${materialsHTML}</div>`;
                    }
                }
                const userProfileSnap = await getDoc(doc(db, 'artifacts', appId, 'users', currentUserId));
                renderBadges(userProfileSnap.data().badges || []);
                document.querySelectorAll('.download-cert-button').forEach(b => b.addEventListener('click', generateCertificate));
                document.querySelectorAll('.open-survey-button').forEach(b => b.addEventListener('click', (e) => openSurvey(e.target.dataset.courseId)));
                document.querySelectorAll('.view-materials-button').forEach(b => b.addEventListener('click', (e) => openCourseMaterials(e.target.dataset.courseId)));
                updateCourseCards();
            });
        }
        
        async function generateCertificate(event) {
            loadingSpinner.style.display = 'flex';
            const { courseName, completionDate } = event.target.dataset;
            document.getElementById('cert-user-name').textContent = currentUser.name;
            document.getElementById('cert-course-name').textContent = courseName;
            document.getElementById('cert-completion-date').textContent = new Date(completionDate).toLocaleDateString('es-AR', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
            try {
                const canvas = await html2canvas(document.getElementById('certificate-template'), { scale: 2 });
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`Certificado-${currentUser.name.replace(/\s/g, '_')}.pdf`);
            } catch (error) { console.error("Error generating PDF:", error); showModal("No se pudo generar el certificado."); }
            finally { loadingSpinner.style.display = 'none'; }
        }
        
        // --- CALENDAR FUNCTIONS ---
        const calendarBody = document.getElementById('calendar-body');
        const monthYearEl = document.getElementById('calendar-month-year');
        function getFirstSaturday(year, month) {
            const first = new Date(year, month, 1);
            const offset = (6 - first.getDay() + 7) % 7;
            return 1 + offset;
        }
        function renderCalendar() {
            calendarBody.innerHTML = '';
            const date = currentCalendarDate;
            const year = date.getFullYear();
            const month = date.getMonth();
            monthYearEl.textContent = `${date.toLocaleString('es-AR', { month: 'long' }).toUpperCase()} ${year}`;
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();
            for (let i = 0; i < startDayOfWeek; i++) { calendarBody.innerHTML += `<div class="calendar-day other-month"></div>`; }
            const cleanupDay = getFirstSaturday(year, month);
            const cleanupDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(cleanupDay).padStart(2, '0')}`;
            const events = allCourses.concat(allEfemerides).concat([{ title: 'Limpieza del r√≠o en la reserva', date: cleanupDateStr, infoOnly: true }]);
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.innerHTML = `<span>${day}</span>`;
                const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const coursesOnThisDay = events.filter(c => c.date === currentDateStr);
                if (coursesOnThisDay.length > 0) {
                    coursesOnThisDay.forEach(ev => {
                        const evDiv = document.createElement('div');
                        evDiv.className = 'calendar-event';
                        evDiv.textContent = ev.title + (ev.infoOnly ? ' (informativo)' : '');
                        dayEl.appendChild(evDiv);
                    });
                    dayEl.style.cursor = 'pointer';
                    dayEl.onclick = () => {
                        const courseTitles = coursesOnThisDay.map(c => `- ${c.title}${c.infoOnly ? ' (informativo)' : ''}`).join('\n');
                        showModal(`Eventos para el ${day}/${month+1}:\n${courseTitles}`);
                    };
                }
                calendarBody.appendChild(dayEl);
            }
        }
        
        // --- GAMIFICATION FUNCTIONS ---
        const badgeSVGs = {
            compostaje: `<svg title="Insignia de Compostaje" class="w-16 h-16" viewBox="0 0 24 24" fill="none" stroke="#065f46" stroke-width="1.5"><path d="M14 13c-1.99-2.005-2.32-4.943-1-7 2.22-3.403 6.54-3.633 8-1 .5 1-1.12 3.89-3.32 5.49-1.5 1.12-3.99 1.5-4.68 2.51zM9.08 14.15l-2.2-2.2-4.95 4.95 2.2 2.2 4.95-4.95z"></path><path d="M10.5 12.5l-1.5-1.5"></path><path d="M4.5 19.5l-1.5-1.5"></path><path d="M15.5 7.5l-1.5-1.5"></path><path d="M12.5 20.5a1 1 0 100-2 1 1 0 000 2zM6.5 14.5a1 1 0 100-2 1 1 0 000 2zM9.5 9.5a1 1 0 100-2 1 1 0 000 2z"></path></svg>`,
            huerta: `<svg title="Insignia de Huerta" class="w-16 h-16" viewBox="0 0 24 24" fill="none" stroke="#065f46" stroke-width="1.5"><path d="M3 21h18M5 21V7l7-4 7 4v14"></path><path d="M9 21v-8a3 3 0 016 0v8"></path></svg>`,
            default: `<svg title="Insignia de Participaci√≥n" class="w-16 h-16" viewBox="0 0 24 24" fill="none" stroke="#065f46" stroke-width="1.5"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 17 17 23 15.79 13.88"></polyline></svg>`
        };
        function renderBadges(userBadges = []) {
            myBadgesList.innerHTML = '';
            if (userBadges.length === 0) { myBadgesList.innerHTML = '<p class="text-gray-500">Completa eventos para ganar insignias.</p>'; return; }
            userBadges.forEach(badgeName => { myBadgesList.innerHTML += badgeSVGs[badgeName] || badgeSVGs.default; });
        }
        
        // --- SURVEY FUNCTIONS ---
        function openSurvey(courseId) {
            document.getElementById('survey-course-id').value = courseId;
            surveyModal.style.display = 'flex';
            document.getElementById('survey-form').reset();
            setupRating('rating-content');
            setupRating('rating-speaker');
        }
        async function handleSurveySubmit(e) {
            e.preventDefault();
            const courseId = document.getElementById('survey-course-id').value;
            const contentRating = document.querySelectorAll('#rating-content .text-yellow-400').length;
            const speakerRating = document.querySelectorAll('#rating-speaker .text-yellow-400').length;
            const comments = document.getElementById('survey-comments').value;
            if (contentRating === 0 || speakerRating === 0) { showModal("Por favor, seleccione una calificaci√≥n para ambas categor√≠as."); return; }
            const surveyData = { contentRating, speakerRating, comments, userId: currentUserId, timestamp: new Date() };
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'courses', courseId, 'surveys'), surveyData);
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUserId, 'enrollments', courseId), { surveyCompleted: true });
                showModal("¬°Gracias por su feedback!");
                surveyModal.style.display = 'none';
            } catch (error) { console.error("Error submitting survey:", error); showModal("No se pudo enviar la encuesta."); }
        }
        function setupRating(containerId) {
            const container = document.getElementById(containerId);
            const stars = container.querySelectorAll('span');
            stars.forEach((star, index) => {
                star.textContent = '‚òÜ';
                star.className = 'text-gray-400';
                star.onclick = () => { stars.forEach((s, i) => { s.textContent = i <= index ? '‚òÖ' : '‚òÜ'; s.className = i <= index ? 'text-yellow-400' : 'text-gray-400'; }); };
            });
        }

        // --- MATERIALS FUNCTIONS ---
        async function openCourseMaterials(courseId) {
            const courseSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', courseId));
            if (!courseSnap.exists()) return;
            const course = courseSnap.data();
            courseMaterialsTitle.textContent = `Material de "${course.title}"`;
            courseMaterialsLinks.innerHTML = (course.materials || []).map(link => `<a href="${link}" target="_blank" class="text-blue-600 hover:underline block">${link}</a>`).join('');
            courseMaterialsModal.style.display = 'flex';
        }

        // --- TURNOS FUNCTIONS ---
        async function loadAvailableTurnos() {
            turnoSlotSelect.innerHTML = '';
            const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'turnos'));
            const available = snapshot.docs.filter(d => !d.data().reserved).sort((a,b)=>{
                const da = a.data(); const dbb = b.data();
                return (da.date + da.time).localeCompare(dbb.date + dbb.time);
            });
            available.forEach(docSnap => {
                const t = docSnap.data();
                const option = document.createElement('option');
                option.value = docSnap.id;
                option.textContent = `${t.date} ${t.time}`;
                turnoSlotSelect.appendChild(option);
            });
            if (available.length === 0) {
                const opt = document.createElement('option');
                opt.textContent = 'No hay turnos disponibles';
                opt.disabled = true; opt.selected = true;
                turnoSlotSelect.appendChild(opt);
            }
        }

        async function loadUserTurnos() {
            misTurnosList.innerHTML = '';
            const ref = collection(db, 'artifacts', appId, 'users', currentUserId, 'turnos');
            const snapshot = await getDocs(ref);
            if (snapshot.empty) { misTurnosList.innerHTML = '<p>No tiene turnos reservados.</p>'; return; }
            snapshot.forEach(async docSnap => {
                const data = docSnap.data();
                const slotSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'turnos', data.slotId));
                if (!slotSnap.exists()) return;
                const slot = slotSnap.data();
                const cancelBtn = `<button data-slot="${docSnap.id}" class="cancel-turno-button bg-red-600 text-white p-2 rounded-lg text-sm">Cancelar</button>`;
                misTurnosList.innerHTML += `<div class="bg-white p-4 rounded-lg shadow flex justify-between items-center"><span>${slot.date} ${slot.time} - ${data.institucion}</span>${cancelBtn}</div>`;
            });
            document.querySelectorAll('.cancel-turno-button').forEach(btn => btn.addEventListener('click', cancelTurno));
        }

        async function bookTurno(e) {
            e.preventDefault();
            if (!currentUserId) { showModal('Debe iniciar sesi√≥n'); return; }
            const slotId = turnoSlotSelect.value;
            if (!slotId) return;
            loadingSpinner.style.display = 'flex';
            try {
                const slotRef = doc(db, 'artifacts', appId, 'public', 'data', 'turnos', slotId);
                const slotSnap = await getDoc(slotRef);
                if (!slotSnap.exists() || slotSnap.data().reserved) { showModal('El turno ya no est√° disponible'); return; }
                const institucion = document.getElementById('turno-institucion').value;
                const alumnos = parseInt(document.getElementById('turno-alumnos').value || '0');
                if (alumnos > 30) { showModal('El n\u00famero m\u00e1ximo de alumnos es 30'); return; }
                const year = new Date().getFullYear();
                const qCount = query(collection(db, 'artifacts', appId, 'public', 'data', 'turnos'), where('reservation.institucion','==', institucion));
                const snapCount = await getDocs(qCount);
                let countYear = 0;
                snapCount.forEach(d => { const r = d.data().reservation; if (r && new Date(r.timestamp).getFullYear() === year) countYear++; });
                if (countYear >= 6) { showModal('La instituci\u00f3n ya alcanz\u00f3 el m\u00e1ximo de 6 talleres este a\u00f1o'); return; }
                const tallerSel = document.getElementById('turno-taller').value;
                const qFirst = query(collection(db, 'artifacts', appId, 'public', 'data', 'turnos'), where('reservation.institucion','==', institucion), where('reservation.taller','==','GIRSU: Reciclables'));
                const snapFirst = await getDocs(qFirst);
                if (tallerSel !== 'GIRSU: Reciclables' && snapFirst.empty) { showModal('Primero debe realizar el taller GIRSU: Reciclables'); return; }
                const reserva = {
                    slotId,
                    institucion,
                    direccion: document.getElementById('turno-direccion').value,
                    esEscuela: document.getElementById('turno-es-escuela').checked,
                    tipo: document.getElementById('turno-tipo').value,
                    grado: document.getElementById('turno-grado').value,
                    nivel: document.getElementById('turno-nivel').value,
                    taller: tallerSel,
                    referente: document.getElementById('turno-referente').value,
                    telefono: document.getElementById('turno-telefono').value,
                    contactoEmail: document.getElementById('turno-email').value,
                    observaciones: document.getElementById('turno-observaciones').value,
                    alumnos,
                    asistentes: document.getElementById('turno-asistentes').value,
                    userId: currentUserId,
                    dni: currentUser.dni,
                    nombre: currentUser.name,
                    email: currentUser.email,
                    timestamp: new Date().toISOString()
                };
                await updateDoc(slotRef, { reserved: true, reservation: reserva });
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUserId, 'turnos', slotId), reserva);
                turnoForm.reset();
                datosEscuelaDiv.style.display = 'none';
                const msgTurno = 'Se envi√≥ un correo de confirmaci√≥n. Recibir√° un recordatorio el d√≠a anterior y un mail de agradecimiento.';
                sendEmail(currentUser.email, 'Turno confirmado', msgTurno);
                showModal(msgTurno);
            } catch(err) { console.error(err); showModal('No se pudo reservar el turno'); }
            finally { loadingSpinner.style.display = 'none'; }
        }

        async function cancelTurno(e) {
            const id = e.target.dataset.slot;
            const slotRef = doc(db, 'artifacts', appId, 'public', 'data', 'turnos', id);
            const slotSnap = await getDoc(slotRef);
            if (!slotSnap.exists()) return;
            const slot = slotSnap.data();
            const slotDate = new Date(`${slot.date}T${slot.time}`);
            if ((slotDate - new Date())/3600000 < 24) { showModal('No puede cancelar con menos de 24h de anticipaci√≥n'); return; }
            await updateDoc(slotRef, { reserved: false, reservation: null });
            await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUserId, 'turnos', id));
            showModal('Turno cancelado');
        }

        // --- ADMIN FUNCTIONS ---
        function showAdminPanel() { isAdminLoggedIn = true; showSection('admin'); loadAdminCourses(); loadAdminNews(); loadAdminTurnos(); loadAdminDashboard(); }
        function loadAdminCourses() {
            const adminCoursesListDiv = document.getElementById('admin-courses-list');
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'courses'), (snapshot) => {
                adminCoursesListDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const course = { id: doc.id, ...doc.data() };
                    adminCoursesListDiv.innerHTML += `<div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center"><div><p class="font-bold text-lg">${course.title}</p><p class="text-sm text-gray-500">${new Date(course.date).toLocaleDateString('es-AR', {timeZone: 'UTC'})}</p></div><div class="flex space-x-2"><button data-course-id="${course.id}" class="view-enrolled-button bg-blue-500 text-white p-2 rounded-lg text-sm">Inscriptos</button><button data-course-id="${course.id}" class="edit-course-button bg-yellow-500 text-white p-2 rounded-lg text-sm">Editar</button><button data-course-id="${course.id}" data-course-title="${course.title}" class="delete-course-button bg-red-500 text-white p-2 rounded-lg text-sm">Eliminar</button></div></div>`;
                });
                document.querySelectorAll('.view-enrolled-button').forEach(b => b.onclick = (e) => showEnrolledUsers(e.target.dataset.courseId));
                document.querySelectorAll('.edit-course-button').forEach(b => b.onclick = (e) => openCourseForm(e.target.dataset.courseId));
                document.querySelectorAll('.delete-course-button').forEach(b => b.onclick = (e) => deleteCourse(e.target.dataset.courseId, e.target.dataset.courseTitle));
            });
        }
        function openCourseForm(courseId = null) {
            courseForm.reset();
            document.getElementById('course-form-title').textContent = courseId ? "Editar Evento" : "Crear Evento";
            if (courseId) {
                getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', courseId)).then(docSnap => {
                    if (docSnap.exists()) {
                        const course = docSnap.data();
                        document.getElementById('course-id').value = courseId;
                        document.getElementById('course-title').value = course.title;
                        document.getElementById('course-description').value = course.description;
                        document.getElementById('course-speaker').value = course.speaker;
                        document.getElementById('course-date').value = course.date;
                        document.getElementById('course-location').value = course.location;
                        document.getElementById('course-format').value = course.format;
                        document.getElementById('course-capacity').value = course.capacity;
                        document.getElementById('course-waitlist').checked = course.waitlist;
                        document.getElementById('course-materials').value = (course.materials || []).join('\n');
                    }
                });
            } else {
                 document.getElementById('course-id').value = '';
            }
            courseFormModal.style.display = 'flex';
        }
        async function saveCourse(e) {
            e.preventDefault();
            loadingSpinner.style.display = 'flex';
            const courseId = document.getElementById('course-id').value;
            const courseData = {
                title: document.getElementById('course-title').value,
                description: document.getElementById('course-description').value,
                speaker: document.getElementById('course-speaker').value,
                date: document.getElementById('course-date').value,
                location: document.getElementById('course-location').value,
                format: document.getElementById('course-format').value,
                capacity: parseInt(document.getElementById('course-capacity').value) || 0,
                waitlist: document.getElementById('course-waitlist').checked,
                materials: document.getElementById('course-materials').value.split('\n').filter(link => link.trim() !== ''),
            };
            try {
                if (courseId) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', courseId), courseData); } 
                else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'courses'), courseData); }
                showModal("Evento guardado.");
                courseFormModal.style.display = 'none';
            } catch (error) { console.error("Error saving course:", error); showModal("Error al guardar."); }
            finally { loadingSpinner.style.display = 'none'; }
        }
        
        function deleteCourse(courseId, courseTitle) {
            showConfirmationModal(`¬øEst√° seguro que desea eliminar el evento "${courseTitle}"? Esta acci√≥n no se puede deshacer.`, async () => {
                loadingSpinner.style.display = 'flex';
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', courseId));
                    showModal("Evento eliminado.");
                } catch (error) { console.error("Error deleting course:", error); showModal("Error al eliminar el evento."); }
                finally { loadingSpinner.style.display = 'none'; }
            });
        }

        async function showEnrolledUsers(courseId) {
            const courseSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', courseId));
            if (!courseSnap.exists()) return;
            document.getElementById('enrolled-users-title').textContent = `Inscriptos en "${courseSnap.data().title}"`;
            document.getElementById('export-csv-button').onclick = () => exportToCSV(courseId, courseSnap.data().title);
            const contentDiv = document.getElementById('enrolled-users-content');
            const enrolledRef = collection(db, 'artifacts', appId, 'public', 'data', 'courses', courseId, 'enrolledUsers');
            onSnapshot(enrolledRef, (snapshot) => {
                contentDiv.innerHTML = '<h4 class="font-bold text-lg mt-4 mb-2">Inscriptos</h4><div class="grid grid-cols-4 font-bold p-2"><p>Nombre</p><p>DNI</p><p>Email</p><p>Acciones</p></div>';
                if (snapshot.empty) contentDiv.innerHTML += '<p class="p-2">Nadie se ha inscripto a√∫n.</p>';
                snapshot.forEach(userDoc => {
                    const user = { id: userDoc.id, ...userDoc.data() };
                    contentDiv.innerHTML += `<div class="grid grid-cols-4 items-center p-2 border-t"><p>${user.name}</p><p>${user.dni}</p><p>${user.email}</p><div>${user.status !== 'finalizado' ? `<button data-user-id="${user.id}" data-user-name="${user.name}" data-course-id="${courseId}" class="mark-complete-button bg-green-500 text-white text-xs p-2 rounded">Marcar Finalizado</button>` : '<span class="text-green-600 font-bold text-xs">Finalizado</span>'}</div></div>`;
                });
                document.querySelectorAll('.mark-complete-button').forEach(b => b.onclick = (e) => markAsCompleted(e.target.dataset.userId, e.target.dataset.courseId, e.target.dataset.userName));
            });
            enrolledUsersModal.style.display = 'flex';
        }
        async function markAsCompleted(userId, courseId, userName) {
            showConfirmationModal(`¬øMarcar a ${userName} como finalizado? Se le otorgar√° una insignia y podr√° descargar su certificado.`, async () => {
                loadingSpinner.style.display = 'flex';
                const completionDate = new Date().toISOString().split('T')[0];
                try {
                    const batch = writeBatch(db);
                    batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'courses', courseId, 'enrolledUsers', userId), { status: 'finalizado' });
                    batch.update(doc(db, 'artifacts', appId, 'users', userId, 'enrollments', courseId), { status: 'finalizado', completionDate: completionDate });
                    const courseSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'courses', courseId));
                    const badge = courseSnap.data().badge || 'default';
                    const userProfileRef = doc(db, 'artifacts', appId, 'users', userId);
                    const userProfileSnap = await getDoc(userProfileRef);
                    const currentBadges = userProfileSnap.data().badges || [];
                    if (!currentBadges.includes(badge)) { batch.update(userProfileRef, { badges: [...currentBadges, badge] }); }
                    await batch.commit();
                    const msgFinal = `Usuario ${userName} marcado como finalizado.`;
                    sendEmail(userProfileSnap.data().email, 'Curso finalizado', msgFinal);
                    showModal(msgFinal);
                } catch (error) { console.error("Error marking as complete:", error); }
                finally { loadingSpinner.style.display = 'none'; }
            });
        }
        async function exportToCSV(courseId, courseTitle) {
            const enrolledUsersRef = collection(db, 'artifacts', appId, 'public', 'data', 'courses', courseId, 'enrolledUsers');
            const waitlistedUsersRef = collection(db, 'artifacts', appId, 'public', 'data', 'courses', courseId, 'waitlistedUsers');
            const [enrolledSnap, waitlistedSnap] = await Promise.all([getDocs(enrolledUsersRef), getDocs(waitlistedUsersRef)]);
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Nombre,DNI,Email,Estado\r\n";
            enrolledSnap.forEach(doc => { const user = doc.data(); csvContent += `"${user.name}","${user.dni}","${user.email}","Inscripto"\r\n`; });
            waitlistedSnap.forEach(doc => { const user = doc.data(); csvContent += `"${user.name}","${user.dni}","${user.email}","En Lista de Espera"\r\n`; });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `inscriptos_${courseTitle.replace(/\s/g, '_')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function exportTurnosCSV(startDate, endDate) {
            const qSnapshot = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'turnos'), where('reserved', '==', true)));
            let csv = 'data:text/csv;charset=utf-8,Fecha,Hora,Institucion,Direccion,Telefono,Email,Alumnos,Asistentes\r\n';
            qSnapshot.forEach(docSnap => {
                const t = docSnap.data();
                const r = t.reservation;
                if (!r) return;
                const ts = r.timestamp || '';
                if (startDate && ts < startDate) return;
                if (endDate && ts > endDate + 'T23:59') return;
                csv += `${t.date},${t.time},"${r.institucion}","${r.direccion}","${r.telefono}","${r.contactoEmail}",${r.alumnos || ''},${r.asistentes}\r\n`;
            });
            const link = document.createElement('a');
            link.setAttribute('href', encodeURI(csv));
            link.setAttribute('download', 'turnos.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function loadAdminNews() {
            const adminNewsListDiv = document.getElementById('admin-news-list');
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'news'), orderBy("date", "desc")), (snapshot) => {
                adminNewsListDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const news = { id: doc.id, ...doc.data() };
                    adminNewsListDiv.innerHTML += `<div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center"><div><p class="font-bold text-lg">${news.title}</p></div><div class="flex space-x-2"><button data-news-id="${news.id}" class="edit-news-button bg-yellow-500 text-white p-2 rounded-lg text-sm">Editar</button><button data-news-id="${news.id}" data-news-title="${news.title}" class="delete-news-button bg-red-500 text-white p-2 rounded-lg text-sm">Eliminar</button></div></div>`;
                });
                document.querySelectorAll('.edit-news-button').forEach(b => b.onclick = (e) => openNewsForm(e.target.dataset.newsId));
                document.querySelectorAll('.delete-news-button').forEach(b => b.onclick = (e) => deleteNews(e.target.dataset.newsId, e.target.dataset.newsTitle));
            });
        }
        function openNewsForm(newsId = null) {
            newsForm.reset();
            document.getElementById('news-form-title').textContent = newsId ? "Editar Noticia" : "Crear Noticia";
            if (newsId) {
                getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'news', newsId)).then(docSnap => {
                    if (docSnap.exists()) {
                        const news = docSnap.data();
                        document.getElementById('news-id').value = newsId;
                        document.getElementById('news-title').value = news.title;
                        document.getElementById('news-content').value = news.content;
                        document.getElementById('news-image-url').value = news.imageUrl || '';
                        document.getElementById('news-files').value = (news.files || []).join('\n');
                    }
                });
            } else {
                document.getElementById('news-id').value = '';
                document.getElementById('news-image-url').value = '';
                document.getElementById('news-files').value = '';
            }
            newsFormModal.style.display = 'flex';
        }
        async function saveNews(e) {
            e.preventDefault();
            loadingSpinner.style.display = 'flex';
            const newsId = document.getElementById('news-id').value;
            const newsData = {
                title: document.getElementById('news-title').value,
                content: document.getElementById('news-content').value,
                imageUrl: document.getElementById('news-image-url').value,
                files: document.getElementById('news-files').value.split('\n').filter(l => l.trim() !== ''),
                date: new Date().toISOString().split('T')[0]
            };
            try {
                if (newsId) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'news', newsId), newsData); } 
                else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'news'), newsData); }
                showModal("Noticia guardada.");
                newsFormModal.style.display = 'none';
            } catch (error) { console.error("Error saving news:", error); showModal("Error al guardar la noticia."); }
            finally { loadingSpinner.style.display = 'none'; }
        }

        function openEfemerideForm(efemerideId = null) {
            const efemerideForm = document.getElementById('efemeride-form');
            efemerideForm.reset();
            document.getElementById('efemeride-form-title').textContent = efemerideId ? "Editar Efem√©ride" : "Crear Efem√©ride";
            const efemerideFormModal = document.getElementById('efemeride-form-modal');

            if (efemerideId) {
                const efemerideRef = doc(db, 'artifacts', appId, 'public', 'data', 'efemerides', efemerideId);
                getDoc(efemerideRef).then(docSnap => {
                    if (docSnap.exists()) {
                        const efemeride = docSnap.data();
                        document.getElementById('efemeride-id').value = efemerideId;
                        document.getElementById('efemeride-title').value = efemeride.title;
                        document.getElementById('efemeride-date').value = efemeride.date;
                    }
                });
            } else {
                 document.getElementById('efemeride-id').value = '';
            }
            efemerideFormModal.style.display = 'flex';
        }

        async function saveEfemeride(e) {
            e.preventDefault();
            loadingSpinner.style.display = 'flex';
            const efemerideId = document.getElementById('efemeride-id').value;
            const efemerideData = {
                title: document.getElementById('efemeride-title').value,
                date: document.getElementById('efemeride-date').value,
                infoOnly: true
            };
            try {
                const efemeridesRef = collection(db, 'artifacts', appId, 'public', 'data', 'efemerides');
                if (efemerideId) {
                    await updateDoc(doc(efemeridesRef, efemerideId), efemerideData);
                } else {
                    await addDoc(efemeridesRef, efemerideData);
                }
                showModal("Efem√©ride guardada.");
                document.getElementById('efemeride-form-modal').style.display = 'none';
            } catch (error) {
                console.error("Error saving efemeride:", error);
                showModal("Error al guardar la efem√©ride.");
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function deleteEfemeride(efemerideId, efemerideTitle) {
            showConfirmationModal(`¬øEst√° seguro que desea eliminar la efem√©ride "${efemerideTitle}"?`, async () => {
                loadingSpinner.style.display = 'flex';
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'efemerides', efemerideId));
                    showModal("Efem√©ride eliminada.");
                } catch (error) {
                    console.error("Error deleting efemeride:", error);
                    showModal("Error al eliminar la efem√©ride.");
                } finally {
                    loadingSpinner.style.display = 'none';
                }
            });
        }
        function deleteNews(newsId, newsTitle) {
            showConfirmationModal(`¬øEst√° seguro que desea eliminar la noticia "${newsTitle}"?`, async () => {
                loadingSpinner.style.display = 'flex';
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'news', newsId));
                    showModal("Noticia eliminada.");
                } catch (error) { console.error("Error deleting news:", error); showModal("Error al eliminar la noticia."); }
                finally { loadingSpinner.style.display = 'none'; }
            });
        }

        function loadAdminEfemerides() {
            const adminEfemeridesListDiv = document.getElementById('admin-efemerides-list');
            const efemeridesRef = collection(db, 'artifacts', appId, 'public', 'data', 'efemerides');
            onSnapshot(query(efemeridesRef, orderBy("date", "desc")), (snapshot) => {
                adminEfemeridesListDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const efemeride = { id: doc.id, ...doc.data() };
                    const displayDate = new Date(efemeride.date).toLocaleDateString('es-AR', {timeZone: 'UTC'});
                    adminEfemeridesListDiv.innerHTML += `<div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center"><div><p class="font-bold text-lg">${efemeride.title}</p><p class="text-sm text-gray-500">${displayDate}</p></div><div class="flex space-x-2"><button data-efemeride-id="${efemeride.id}" class="edit-efemeride-button bg-yellow-500 text-white p-2 rounded-lg text-sm">Editar</button><button data-efemeride-id="${efemeride.id}" data-efemeride-title="${efemeride.title}" class="delete-efemeride-button bg-red-500 text-white p-2 rounded-lg text-sm">Eliminar</button></div></div>`;
                });
                document.querySelectorAll('.edit-efemeride-button').forEach(b => b.onclick = (e) => openEfemerideForm(e.target.dataset.efemerideId));
                document.querySelectorAll('.delete-efemeride-button').forEach(b => b.onclick = (e) => deleteEfemeride(e.target.dataset.efemerideId, e.target.dataset.efemerideTitle));
            });
        }

        function loadAdminTurnos() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'turnos'), (snapshot) => {
                adminTurnosList.innerHTML = '';
                adminTurnosReserved.innerHTML = '';
                adminTurnosFree.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const t = { id: docSnap.id, ...docSnap.data() };
                    const baseInfo = `${t.date} ${t.time}`;
                    adminTurnosList.innerHTML += `<div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center"><span>${baseInfo}${t.reserved ? ' - Reservado' : ''}</span><div class="flex space-x-2"><button data-slot-id="${t.id}" class="edit-slot-button bg-yellow-500 text-white p-2 rounded-lg text-sm">Editar</button><button data-slot-id="${t.id}" class="delete-slot-button bg-red-500 text-white p-2 rounded-lg text-sm">Eliminar</button></div></div>`;
                    if (t.reserved && t.reservation) {
                        const r = t.reservation;
                        adminTurnosReserved.innerHTML += `<div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center"><span>${baseInfo} - ${r.institucion}</span><button data-slot-id="${t.id}" class="admin-cancel-slot bg-red-600 text-white p-2 rounded-lg text-sm">Cancelar</button></div>`;
                    } else {
                        adminTurnosFree.innerHTML += `<div class="bg-white p-4 rounded-lg shadow-md">${baseInfo}</div>`;
                    }
                });
                document.querySelectorAll('.edit-slot-button').forEach(b => b.onclick = (e) => openSlotForm(e.target.dataset.slotId));
                document.querySelectorAll('.delete-slot-button').forEach(b => b.onclick = (e) => deleteSlot(e.target.dataset.slotId));
                document.querySelectorAll('.admin-cancel-slot').forEach(b => b.onclick = (e) => cancelSlotAdmin(e.target.dataset.slotId));
            });
        }

        function openSlotForm(slotId = null) {
            slotForm.reset();
            document.getElementById('slot-form-title').textContent = slotId ? 'Editar Turno' : 'Nuevo Turno';
            if (slotId) {
                getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'turnos', slotId)).then(snap => {
                    if (snap.exists()) {
                        const d = snap.data();
                        document.getElementById('slot-id').value = slotId;
                        document.getElementById('slot-date').value = d.date;
                        document.getElementById('slot-time').value = d.time;
                    }
                });
            } else { document.getElementById('slot-id').value = ''; }
            slotFormModal.style.display = 'flex';
        }

        async function generateMonthSlots() {
            const month = prompt('Ingrese mes (AAAA-MM):');
            if (!month) return;
            const parts = month.split('-');
            if (parts.length !== 2) { showModal('Formato inv√°lido'); return; }
            const year = parseInt(parts[0]);
            const monthNum = parseInt(parts[1]) - 1;
            if (isNaN(year) || isNaN(monthNum)) { showModal('Formato inv√°lido'); return; }
            loadingSpinner.style.display = 'flex';
            try {
                const daysInMonth = new Date(year, monthNum + 1, 0).getDate();
                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(year, monthNum, d);
                    if ([2,4].includes(date.getDay())) { // martes y jueves
                        const dateStr = date.toISOString().split('T')[0];
                        for (const time of ['09:00','11:00','13:00','15:00']) {
                            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'turnos'), where('date','==', dateStr), where('time','==', time));
                            const snap = await getDocs(q);
                            if (snap.empty) {
                                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'turnos'), { date: dateStr, time, reserved: false });
                            }
                        }
                    }
                }
                showModal('Turnos del mes generados.');
            } catch(err) { console.error(err); showModal('No se pudo generar turnos.'); }
            finally { loadingSpinner.style.display = 'none'; }
        }

        async function saveSlot(e) {
            e.preventDefault();
            loadingSpinner.style.display = 'flex';
            const id = document.getElementById('slot-id').value;
            const date = document.getElementById('slot-date').value;
            const time = document.getElementById('slot-time').value;
            const day = new Date(date + 'T00:00').getDay();
            if (![1,2,4,5].includes(day)) { showModal('Solo se permiten turnos lunes, martes, jueves y viernes'); return; }
            if (!['09:00','11:00','13:30','15:00'].includes(time)) { showModal('Horario de turno no v√°lido'); return; }
            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'turnos'), where('date','==', date));
                const snapshot = await getDocs(q);
                if (!id && snapshot.size >= 4) { showModal('Ya existen 4 turnos para ese d√≠a'); return; }
                const data = { date, time, reserved: false };
                if (id) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'turnos', id), data); }
                else { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'turnos'), data); }
                slotFormModal.style.display = 'none';
            } catch(err) { console.error(err); showModal('Error guardando turno'); }
            finally { loadingSpinner.style.display = 'none'; }
        }

        function deleteSlot(slotId) {
            showConfirmationModal('¬øEliminar turno?', async () => {
                loadingSpinner.style.display = 'flex';
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'turnos', slotId)); }
                catch(err){ console.error(err); }
                finally { loadingSpinner.style.display = 'none'; }
            });
        }

function cancelSlotAdmin(slotId) {
            showConfirmationModal('¬øCancelar reserva de este turno?', async () => {
                loadingSpinner.style.display = 'flex';
                try {
                    const slotRef = doc(db, 'artifacts', appId, 'public', 'data', 'turnos', slotId);
                    const snap = await getDoc(slotRef);
                    if (snap.exists() && snap.data().reserved) {
                        const r = snap.data().reservation;
                        await updateDoc(slotRef, { reserved: false, reservation: null });
                        if (r && r.userId) {
                            await deleteDoc(doc(db, 'artifacts', appId, 'users', r.userId, 'turnos', slotId));
                        }
                        const msgCancel = 'Reserva cancelada. Se envi√≥ un correo informando la cancelaci√≥n.';
                        const dest = (r && r.contactoEmail) ? r.contactoEmail : r.email;
                        if (dest) sendEmail(dest, 'Turno cancelado', msgCancel);
                        showModal(msgCancel);
                    }
                } catch(err) { console.error(err); showModal('No se pudo cancelar.'); }
                finally { loadingSpinner.style.display = 'none'; }
            });
        }

        async function loadAdminDashboard() {
            dashboardStats.innerHTML = '';
            const coursesSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'courses'));
            const courseLabels = [];
            const enrollCounts = [];
            let totalEnrollments = 0;
            for (const docSnap of coursesSnap.docs) {
                courseLabels.push(docSnap.data().title);
                const enrolledSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'courses', docSnap.id, 'enrolledUsers'));
                enrollCounts.push(enrolledSnap.size);
                totalEnrollments += enrolledSnap.size;
            }
            const turnosSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'turnos'));
            const schools = new Set();
            let reservedCount = 0;
            turnosSnap.forEach(t => { const d = t.data(); if (d.reserved && d.reservation) { reservedCount++; if (d.reservation.esEscuela) schools.add(d.reservation.institucion); } });
            dashboardStats.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow"><p class="text-lg font-bold brand-green">${coursesSnap.size}</p><p class="text-sm text-gray-600">Eventos</p></div>
                    <div class="bg-white p-4 rounded-lg shadow"><p class="text-lg font-bold brand-green">${totalEnrollments}</p><p class="text-sm text-gray-600">Inscriptos</p></div>
                    <div class="bg-white p-4 rounded-lg shadow"><p class="text-lg font-bold brand-green">${schools.size}</p><p class="text-sm text-gray-600">Escuelas registradas</p></div>
                    <div class="bg-white p-4 rounded-lg shadow"><p class="text-lg font-bold brand-green">${reservedCount}</p><p class="text-sm text-gray-600">Turnos reservados</p></div>
                </div>`;
            if (enrollChart) enrollChart.destroy();
            const ctx = document.getElementById('enroll-chart').getContext('2d');
            enrollChart = new Chart(ctx, { type: 'bar', data: { labels: courseLabels, datasets: [{ label: 'Inscriptos', data: enrollCounts, backgroundColor: '#065f46' }] }, options: { plugins: { legend: { display: false } } } });
        }

        async function loadAdminEnrollments() {
            enrollmentsTableBody.innerHTML = '';
            const coursesSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'courses'));
            for (const courseDoc of coursesSnap.docs) {
                const courseTitle = courseDoc.data().title;
                const enrolledSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'courses', courseDoc.id, 'enrolledUsers'));
                for (const userDoc of enrolledSnap.docs) {
                    const uid = userDoc.id;
                    let userData = null;
                    try { const uSnap = await getDoc(doc(db, 'artifacts', appId, 'users', uid)); if (uSnap.exists()) userData = uSnap.data(); } catch(err) {}
                    const name = userData ? userData.name : userDoc.data().name;
                    const institucion = userData ? userData.address || '' : '';
                    const huerta = userData ? (userData.hasHuerta ? 'S√≠' : 'No') : '';
                    enrollmentsTableBody.innerHTML += `<tr class="border-t"><td class="px-4 py-2">${name}</td><td class="px-4 py-2">${institucion}</td><td class="px-4 py-2">${huerta}</td><td class="px-4 py-2">${courseTitle}</td></tr>`;
                }
            }
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); attemptLogin(document.getElementById('dni-input').value); });
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingSpinner.style.display = 'flex';
            const userData = {
                dni: document.getElementById('register-dni').value,
                name: document.getElementById('register-name').value,
                address: document.getElementById('register-address').value,
                phone: document.getElementById('register-phone').value,
                email: document.getElementById('register-email').value,
                hasHuerta: document.querySelector('input[name="huerta-compostera"]:checked').value === 'si',
                huertaAddress: document.getElementById('register-huerta-address').value,
                badges: []
            };
            try {
                const newUserId = auth.currentUser.uid;
                await setDoc(doc(db, 'artifacts', appId, 'users', newUserId), userData);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dni_registry', userData.dni), { uid: newUserId });
                currentUser = userData;
                currentUserId = newUserId;
                localStorage.setItem('userDNI', userData.dni);
                await showMainApp();
            } catch (error) { console.error("Error during registration:", error); }
            finally { loadingSpinner.style.display = 'none'; }
        });
        document.querySelectorAll('input[name="huerta-compostera"]').forEach(radio => radio.addEventListener('change', (e) => { document.getElementById('huerta-address-container').style.display = e.target.value === 'si' ? 'block' : 'none'; }));
        Object.keys(tabs).forEach(key => tabs[key].addEventListener('click', () => showView(key)));
        document.getElementById('logout-button').addEventListener('click', () => { localStorage.removeItem('userDNI'); currentUser = null; currentUserId = null; userInfoDiv.style.display = 'none'; document.getElementById('dni-input').value = ''; showSection('login'); });
        document.getElementById('modal-close-button').addEventListener('click', () => { document.getElementById('message-modal').style.display = 'none'; });
        document.getElementById('prev-month-btn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month-btn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); });
        document.getElementById('survey-form').addEventListener('submit', handleSurveySubmit);
        document.getElementById('cancel-survey-form').addEventListener('click', () => surveyModal.style.display = 'none');
        document.getElementById('admin-login-button').addEventListener('click', () => { adminPasswordModal.style.display = 'flex'; document.getElementById('admin-password-input').focus(); });
        document.getElementById('admin-password-form').addEventListener('submit', (e) => { e.preventDefault(); const pass = document.getElementById('admin-password-input').value; if (pass === "admin123") { adminPasswordModal.style.display = 'none'; document.getElementById('admin-password-input').value = ''; showAdminPanel(); } else { showModal("Contrase√±a incorrecta."); } });
        document.getElementById('cancel-admin-password-form').addEventListener('click', () => { adminPasswordModal.style.display = 'none'; document.getElementById('admin-password-input').value = ''; });
        document.getElementById('admin-logout-button').addEventListener('click', () => { isAdminLoggedIn = false; if (currentUser) { showSection('main'); } else { showSection('login'); } });
        document.querySelectorAll('.admin-tab-button').forEach(button => button.addEventListener('click', (e) => {
            document.querySelectorAll('.admin-tab-button').forEach(b => b.className = 'admin-tab-button px-4 py-2 font-medium text-gray-500');
            e.target.className = 'admin-tab-button px-4 py-2 font-medium border-b-4 brand-border-green brand-green';
            document.getElementById('admin-dashboard-view').style.display = e.target.dataset.view === 'admin-dashboard' ? 'block' : 'none';
            document.getElementById('admin-courses-view').style.display = e.target.dataset.view === 'admin-courses' ? 'block' : 'none';
            document.getElementById('admin-turnos-view').style.display = e.target.dataset.view === 'admin-turnos' ? 'block' : 'none';
            document.getElementById('admin-news-view').style.display = e.target.dataset.view === 'admin-news' ? 'block' : 'none';
            document.getElementById('admin-efemerides-view').style.display = e.target.dataset.view === 'admin-efemerides' ? 'block' : 'none';
            document.getElementById('admin-enrollments-view').style.display = e.target.dataset.view === 'admin-enrollments' ? 'block' : 'none';
            if(e.target.dataset.view === 'admin-dashboard') loadAdminDashboard();
            if(e.target.dataset.view === 'admin-enrollments') loadAdminEnrollments();
            if(e.target.dataset.view === 'admin-efemerides') loadAdminEfemerides();
        }));
        document.getElementById('add-course-button').addEventListener('click', () => openCourseForm());
        document.getElementById('cancel-course-form').addEventListener('click', () => courseFormModal.style.display = 'none');
        courseForm.addEventListener('submit', saveCourse);
        document.getElementById('add-news-button').addEventListener('click', () => openNewsForm());
        document.getElementById('cancel-news-form').addEventListener('click', () => newsFormModal.style.display = 'none');
        newsForm.addEventListener('submit', saveNews);
        document.getElementById('add-efemeride-button').addEventListener('click', () => openEfemerideForm());
        document.getElementById('cancel-efemeride-form').addEventListener('click', () => { document.getElementById('efemeride-form-modal').style.display = 'none'; });
        document.getElementById('efemeride-form').addEventListener('submit', saveEfemeride);
        addSlotButton.addEventListener('click', () => openSlotForm());
        generateMonthButton.addEventListener('click', generateMonthSlots);
        document.getElementById('cancel-slot-form').addEventListener('click', () => slotFormModal.style.display = 'none');
        slotForm.addEventListener('submit', saveSlot);
        turnoForm.addEventListener('submit', bookTurno);
        document.getElementById('turno-es-escuela').addEventListener('change', e => {
            const isEscuela = e.target.checked;
            datosEscuelaDiv.style.display = isEscuela ? 'block' : 'none';
            document.getElementById('escuela-note').style.display = isEscuela ? 'block' : 'none';
            document.getElementById('turno-asistentes').max = isEscuela ? '' : 30;
        });
        document.getElementById('close-enrolled-users-modal').addEventListener('click', () => enrolledUsersModal.style.display = 'none');
        document.getElementById('close-course-materials-modal').addEventListener('click', () => courseMaterialsModal.style.display = 'none');
        document.getElementById('export-turnos').addEventListener('click', () => {
            const start = document.getElementById('export-start').value;
            const end = document.getElementById('export-end').value;
            exportTurnosCSV(start, end);
        });
        document.getElementById('cancel-confirmation-button').addEventListener('click', () => { confirmationModal.style.display = 'none'; actionToConfirm = null; });
        document.getElementById('confirm-action-button').addEventListener('click', () => { if (typeof actionToConfirm === 'function') { actionToConfirm(); } confirmationModal.style.display = 'none'; actionToConfirm = null; });

        // --- INITIAL LOAD ---
        initializeAuth();
    </script>
</body>
</html>
